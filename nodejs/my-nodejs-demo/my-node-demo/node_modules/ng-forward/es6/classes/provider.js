import { bundleStore, providerStore } from '../writers';
import Module from './module';
import { Inject } from '../decorators/inject';
import { getInjectableNameWithJitCreation } from '../util/get-injectable-name';
import { Providers } from '../decorators/providers';
import { INJECTABLE } from '../decorators/injectable';
const TYPE = 'provider';
export class Provider {
    constructor(token, { useClass, useValue, useConstant, useFactory, deps }) {
        this._dependencies = [];
        try {
            this.token = getInjectableNameWithJitCreation(token);
        }
        catch (e) {
            throw new Error(`new Provider() Error: Invalid token ${token}`);
        }
        Object.assign(this, { useClass, useValue, useConstant, useFactory });
        if (!useClass && !useValue && !useConstant && !useFactory) {
            throw new Error(`new Provider(${token}) Error: No usage provided (i.e. useClass, useValue, useConstant, useFactory)`);
        }
        if (deps) {
            Inject(...deps)(this.useFactory);
            Providers(...deps.filter(d => typeof d !== 'string'))(this.useFactory, `while analyzing Provider '${this.token}' useFactory deps`);
            this._dependencies = bundleStore.get('$inject', this.useFactory);
        }
        providerStore.set('name', this.token, this);
        providerStore.set('type', TYPE, this);
    }
    get type() {
        if (this._type)
            return this._type;
        this._type = Object.keys(this).find((k) => k.startsWith('use') && this[k] !== undefined);
        return this._type;
    }
    get dependencies() {
        return this._dependencies;
    }
}
Module.addProvider(TYPE, (provider, name, injects, ngModule) => {
    switch (provider.type) {
        case 'useValue':
            ngModule.value(provider.token, provider.useValue);
            break;
        case 'useConstant':
            ngModule.constant(provider.token, provider.useConstant);
            break;
        case 'useClass':
            injects = bundleStore.get('$inject', provider.useClass) || [];
            Module.getParser(INJECTABLE)(provider.useClass, provider.token, injects, ngModule);
            break;
        case 'useFactory':
            ngModule.factory(provider.token, [...provider.dependencies, provider.useFactory]);
            break;
        default:
            break;
    }
});
export const provide = (token, { useClass, useValue, useConstant, useFactory, deps }) => {
    return new Provider(token, { useClass, useValue, useConstant, useFactory, deps });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGFzc2VzL3Byb3ZpZGVyLnRzIl0sIm5hbWVzIjpbIlByb3ZpZGVyIiwiUHJvdmlkZXIuY29uc3RydWN0b3IiLCJQcm92aWRlci50eXBlIiwiUHJvdmlkZXIuZGVwZW5kZW5jaWVzIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZO09BQ2hELE1BQU0sTUFBTSxVQUFVO09BQ3RCLEVBQUMsTUFBTSxFQUFDLE1BQU0sc0JBQXNCO09BQ3BDLEVBQUMsZ0NBQWdDLEVBQUMsTUFBTSw2QkFBNkI7T0FDckUsRUFBQyxTQUFTLEVBQUMsTUFBTSx5QkFBeUI7T0FDMUMsRUFBQyxVQUFVLEVBQUMsTUFBTSwwQkFBMEI7QUFHbkQsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDO0FBS3hCO0lBU0VBLFlBQVlBLEtBQWtDQSxFQUM1Q0EsRUFDRUEsUUFBUUEsRUFDUkEsUUFBUUEsRUFDUkEsV0FBV0EsRUFDWEEsVUFBVUEsRUFDVkEsSUFBSUEsRUFRTEE7UUFqQktDLGtCQUFhQSxHQUFhQSxFQUFFQSxDQUFDQTtRQW1CbkNBLElBQUlBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLGdDQUFnQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFBQ0EsQ0FDNURBO1FBQUFBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQUNBLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLHVDQUF1Q0EsS0FBS0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFBQ0EsQ0FBQ0E7UUFFOUVBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLEVBQUVBLEVBQUNBLFFBQVFBLEVBQUVBLFFBQVFBLEVBQUVBLFdBQVdBLEVBQUVBLFVBQVVBLEVBQUNBLENBQUNBLENBQUNBO1FBRW5FQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxRQUFRQSxJQUFJQSxDQUFDQSxRQUFRQSxJQUFJQSxDQUFDQSxXQUFX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WUFDbEYsS0FBSyxDQUFDO1FBQ1Y7WUFDSSxLQUFLLENBQUM7SUFDWixDQUFDO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFPSCxhQUFhLE9BQU8sR0FBRyxDQUFDLEtBQWtDLEVBQ3RELEVBQ0UsUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsVUFBVSxFQUNWLElBQUksRUFRTDtJQUVILE1BQU0sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztBQUNsRixDQUFDLENBQUMiLCJmaWxlIjoibGliL2NsYXNzZXMvcHJvdmlkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBidW5kbGVTdG9yZSwgcHJvdmlkZXJTdG9yZSB9IGZyb20gJy4uL3dyaXRlcnMnO1xuaW1wb3J0IE1vZHVsZSBmcm9tICcuL21vZHVsZSc7XG5pbXBvcnQge0luamVjdH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9pbmplY3QnO1xuaW1wb3J0IHtnZXRJbmplY3RhYmxlTmFtZVdpdGhKaXRDcmVhdGlvbn0gZnJvbSAnLi4vdXRpbC9nZXQtaW5qZWN0YWJsZS1uYW1lJztcbmltcG9ydCB7UHJvdmlkZXJzfSBmcm9tICcuLi9kZWNvcmF0b3JzL3Byb3ZpZGVycyc7XG5pbXBvcnQge0lOSkVDVEFCTEV9IGZyb20gJy4uL2RlY29yYXRvcnMvaW5qZWN0YWJsZSc7XG5pbXBvcnQge09wYXF1ZVRva2VufSBmcm9tIFwiLi9vcGFxdWUtdG9rZW5cIjtcblxuY29uc3QgVFlQRSA9ICdwcm92aWRlcic7XG5cbi8qKlxuICogQSBiaW5kaW5nIGZyb20gYSB0b2tlbiB0byBhIHZhbHVlIChvbmx5IG9uZSBpbXBsZW1lbnRlZCBjdXJyZW50bHkpLCBjbGFzcywgZXhpc3RpbmcsIG9yIGZhY3RvcnlcbiAqL1xuZXhwb3J0IGNsYXNzIFByb3ZpZGVyIHtcbiAgcHVibGljIHRva2VuOiBhbnk7XG4gIHB1YmxpYyB1c2VDbGFzczogYW55O1xuICBwdWJsaWMgdXNlVmFsdWU6IGFueTtcbiAgcHVibGljIHVzZUNvbnN0YW50OiBhbnk7XG4gIHB1YmxpYyB1c2VGYWN0b3J5OiBhbnk7XG4gIHByaXZhdGUgX2RlcGVuZGVuY2llczogc3RyaW5nW10gPSBbXTtcbiAgcHJpdmF0ZSBfdHlwZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHRva2VuOiBzdHJpbmd8T3BhcXVlVG9rZW58RnVuY3Rpb24sXG4gICAge1xuICAgICAgdXNlQ2xhc3MsXG4gICAgICB1c2VWYWx1ZSwgXG4gICAgICB1c2VDb25zdGFudCwgXG4gICAgICB1c2VGYWN0b3J5LCBcbiAgICAgIGRlcHNcbiAgICB9IDogXG4gICAgeyBcbiAgICAgIHVzZUNsYXNzPzogYW55LCBcbiAgICAgIHVzZVZhbHVlPzogYW55LCBcbiAgICAgIHVzZUNvbnN0YW50PzogYW55LCBcbiAgICAgIHVzZUZhY3Rvcnk/OiBhbnksIFxuICAgICAgZGVwcz86IGFueVtdXG4gICAgfVxuICApIHtcbiAgICB0cnkgeyB0aGlzLnRva2VuID0gZ2V0SW5qZWN0YWJsZU5hbWVXaXRoSml0Q3JlYXRpb24odG9rZW4pOyB9XG4gICAgY2F0Y2ggKGUpIHsgdGhyb3cgbmV3IEVycm9yKGBuZXcgUHJvdmlkZXIoKSBFcnJvcjogSW52YWxpZCB0b2tlbiAke3Rva2VufWApOyB9XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHt1c2VDbGFzcywgdXNlVmFsdWUsIHVzZUNvbnN0YW50LCB1c2VGYWN0b3J5fSk7XG5cbiAgICBpZiAoIXVzZUNsYXNzICYmICF1c2VWYWx1ZSAmJiAhdXNlQ29uc3RhbnQgJiYgIXVzZUZhY3RvcnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgbmV3IFByb3ZpZGVyKCR7dG9rZW59KSBFcnJvcjogTm8gdXNhZ2UgcHJvdmlkZWQgKGkuZS4gdXNlQ2xhc3MsIHVzZVZhbHVlLCB1c2VDb25zdGFudCwgdXNlRmFjdG9yeSlgKVxuICAgIH1cblxuICAgIGlmIChkZXBzKSB7XG4gICAgICAvLyBTaW11bGF0ZSBoYXZpbmcgYm90aCBhbiBASW5qZWN0IGFuZCBwcm92aWRlOiBbXSBvbiB0aGUgZmFjdG9yeSBmdW5jdGlvblxuICAgICAgSW5qZWN0KC4uLmRlcHMpKHRoaXMudXNlRmFjdG9yeSk7XG4gICAgICBQcm92aWRlcnMoLi4uZGVwcy5maWx0ZXIoZCA9PiB0eXBlb2YgZCAhPT0gJ3N0cmluZycpKSh0aGlzLnVzZUZhY3RvcnksIGB3aGlsZSBhbmFseXppbmcgUHJvdmlkZXIgJyR7dGhpcy50b2tlbn0nIHVzZUZhY3RvcnkgZGVwc2ApO1xuICAgICAgdGhpcy5fZGVwZW5kZW5jaWVzID0gYnVuZGxlU3RvcmUuZ2V0KCckaW5qZWN0JywgdGhpcy51c2VGYWN0b3J5KTtcbiAgICB9XG5cbiAgICAvLyBTZXR1cCBwcm92aWRlciBpbmZvcm1hdGlvbiB1c2luZyB0aGUgcGFyc2VkIHNlbGVjdG9yXG4gICAgcHJvdmlkZXJTdG9yZS5zZXQoJ25hbWUnLCB0aGlzLnRva2VuLCB0aGlzKTtcbiAgICBwcm92aWRlclN0b3JlLnNldCgndHlwZScsIFRZUEUsIHRoaXMpO1xuICB9XG5cbiAgZ2V0IHR5cGUoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5fdHlwZSkgcmV0dXJuIHRoaXMuX3R5cGU7XG4gICAgXG4gICAgdGhpcy5fdHlwZSA9IE9iamVjdC5rZXlzKHRoaXMpLmZpbmQoKGs6IHN0cmluZykgOiBib29sZWFuID0+IGsuc3RhcnRzV2l0aCgndXNlJykgJiYgdGhpc1trXSAhPT0gdW5kZWZpbmVkKTtcbiAgICBcbiAgICByZXR1cm4gdGhpcy5fdHlwZTtcbiAgfVxuICBcbiAgZ2V0IGRlcGVuZGVuY2llcygpOiBzdHJpbmdbXXtcbiAgICByZXR1cm4gdGhpcy5fZGVwZW5kZW5jaWVzO1xuICB9XG59XG5cblxuLy8gIyMgUHJvdmlkZXIgUGFyc2VyXG5Nb2R1bGUuYWRkUHJvdmlkZXIoVFlQRSwgKHByb3ZpZGVyOiBQcm92aWRlciwgbmFtZTogc3RyaW5nLCBpbmplY3RzOiBzdHJpbmdbXSwgbmdNb2R1bGU6IG5nLklNb2R1bGUpID0+IHtcbiAgc3dpdGNoIChwcm92aWRlci50eXBlKSB7XG4gICAgY2FzZSAndXNlVmFsdWUnOlxuICAgICAgICBuZ01vZHVsZS52YWx1ZShwcm92aWRlci50b2tlbiwgcHJvdmlkZXIudXNlVmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICBjYXNlICd1c2VDb25zdGFudCc6XG4gICAgICAgIG5nTW9kdWxlLmNvbnN0YW50KHByb3ZpZGVyLnRva2VuLCBwcm92aWRlci51c2VDb25zdGFudCk7XG4gICAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3VzZUNsYXNzJzpcbiAgICAgICAgaW5qZWN0cyA9IGJ1bmRsZVN0b3JlLmdldCgnJGluamVjdCcsIHByb3ZpZGVyLnVzZUNsYXNzKSB8fCBbXTtcbiAgICAgICAgTW9kdWxlLmdldFBhcnNlcihJTkpFQ1RBQkxFKShwcm92aWRlci51c2VDbGFzcywgcHJvdmlkZXIudG9rZW4sIGluamVjdHMsIG5nTW9kdWxlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgY2FzZSAndXNlRmFjdG9yeSc6XG4gICAgICAgIG5nTW9kdWxlLmZhY3RvcnkocHJvdmlkZXIudG9rZW4sIFsuLi5wcm92aWRlci5kZXBlbmRlbmNpZXMsIHByb3ZpZGVyLnVzZUZhY3RvcnldKTtcbiAgICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gIH1cbn0pO1xuXG5cbi8qKlxuICogU3VnYXIgZm9yIGNyZWF0aW5nIGEgbmV3IGJpbmRpbmcuXG4gKiBAcGFyYW0gdG9rZW5cbiAqL1xuZXhwb3J0IGNvbnN0IHByb3ZpZGUgPSAodG9rZW46IHN0cmluZ3xPcGFxdWVUb2tlbnxGdW5jdGlvbixcbiAgICB7XG4gICAgICB1c2VDbGFzcyxcbiAgICAgIHVzZVZhbHVlLCBcbiAgICAgIHVzZUNvbnN0YW50LCBcbiAgICAgIHVzZUZhY3RvcnksIFxuICAgICAgZGVwc1xuICAgIH0gOiBcbiAgICB7IFxuICAgICAgdXNlQ2xhc3M/OiBhbnksIFxuICAgICAgdXNlVmFsdWU/OiBhbnksIFxuICAgICAgdXNlQ29uc3RhbnQ/OiBhbnksIFxuICAgICAgdXNlRmFjdG9yeT86IGFueSwgXG4gICAgICBkZXBzPzogYW55W11cbiAgICB9XG4gICkgOiBQcm92aWRlciA9PiB7XG4gIHJldHVybiBuZXcgUHJvdmlkZXIodG9rZW4sIHt1c2VDbGFzcywgdXNlVmFsdWUsIHVzZUNvbnN0YW50LCB1c2VGYWN0b3J5LCBkZXBzfSk7XG59OyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
