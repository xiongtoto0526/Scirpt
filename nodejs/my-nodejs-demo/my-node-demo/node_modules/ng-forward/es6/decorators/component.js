import parseSelector from '../util/parse-selector';
import { providerStore, componentStore, bundleStore } from '../writers';
import { Providers } from './providers';
import Module from '../classes/module';
import directiveControllerFactory from '../util/directive-controller';
import { writeMapMulti } from './input-output';
import { inputsMap } from '../properties/inputs-builder';
import events from '../events/events';
import { createConfigErrorMessage } from '../util/helpers';
const TYPE = 'component';
export const componentHooks = {
    _after: [],
    _extendDDO: [],
    _beforeCtrlInvoke: [],
    _afterCtrlInvoke: [],
    after(fn) {
        this._after.push(fn);
    },
    extendDDO(fn) {
        this._extendDDO.push(fn);
    },
    beforeCtrlInvoke(fn) {
        this._beforeCtrlInvoke.push(fn);
    },
    afterCtrlInvoke(fn) {
        this._afterCtrlInvoke.push(fn);
    }
};
export function Component({ selector, controllerAs, template, templateUrl, providers = [], inputs = [], outputs = [], pipes = [], directives = [] }) {
    return function (t) {
        if (!selector) {
            throw new Error(`Component Decorator Error in "${t.name}": Component selector must be provided`);
        }
        let { name, type: restrict } = parseSelector(selector);
        providerStore.set('name', name, t);
        providerStore.set('type', TYPE, t);
        bundleStore.set('selector', selector, t);
        Providers(...providers)(t, `while analyzing Component '${t.name}' providers`);
        componentStore.set('restrict', restrict, t);
        componentStore.set('scope', {}, t);
        componentStore.set('transclude', true, t);
        componentStore.set('bindToController', true, t);
        [
            ['inputs', inputs],
            ['providers', providers],
            ['directives', directives],
            ['outputs', outputs]
        ].forEach(([propName, propVal]) => {
            if (propVal !== undefined && !Array.isArray(propVal)) {
                throw new TypeError(`Component Decorator Error in "${t.name}": Component ${propName} must be an array`);
            }
        });
        writeMapMulti(t, inputs, 'inputMap');
        let outputMap = writeMapMulti(t, outputs, 'outputMap');
        Object.keys(outputMap).forEach(key => events.add(key));
        if (controllerAs === '$auto') {
            componentStore.set('controllerAs', name, t);
        }
        else if (controllerAs) {
            componentStore.set('controllerAs', controllerAs, t);
        }
        else {
            componentStore.set('controllerAs', 'ctrl', t);
        }
        if (t.link) {
            componentStore.set('link', t.link, t);
        }
        if (t.compile) {
            componentStore.set('compile', t.compile, t);
        }
        View({
            selector,
            template,
            templateUrl,
            pipes,
            directives
        })(t);
    };
}
export function View({ selector, template, templateUrl, pipes = [], directives = [] }) {
    return function (t) {
        if (templateUrl) {
            componentStore.set('templateUrl', templateUrl, t);
        }
        else if (template) {
            componentStore.set('template', template, t);
        }
        else {
            throw new Error(`@Component config must include either a template or a template url for component with selector ${selector} on ${t.name}`);
        }
        Providers(...directives)(t, `while analyzing Component '${t.name}' directives`);
        Providers(...pipes)(t, `while analyzing Component '${t.name}' pipes`);
    };
}
Module.addProvider(TYPE, (target, name, injects, ngModule) => {
    let ddo = {};
    componentStore.forEach((val, key) => ddo[key] = val, target);
    let bindProp = angular.version.minor >= 4 ? 'bindToController' : 'scope';
    ddo[bindProp] = inputsMap(ddo.inputMap);
    if (ddo.restrict !== 'E') {
        throw new Error(createConfigErrorMessage(target, ngModule, `@Component selectors can only be elements. ` +
            `Perhaps you meant to use @Directive?`));
    }
    controller.$inject = ['$scope', '$element', '$attrs', '$transclude', '$injector'];
    function controller($scope, $element, $attrs, $transclude, $injector) {
        let locals = { $scope, $element, $attrs, $transclude };
        return directiveControllerFactory(this, injects, target, ddo, $injector, locals);
    }
    ddo.controller = controller;
    if (ddo.template && ddo.template.replace) {
        ddo.template = ddo.template.replace(/ng-content/g, 'ng-transclude');
    }
    componentHooks._extendDDO.forEach(hook => hook(ddo, target, name, injects, ngModule));
    ngModule.directive(name, () => ddo);
    componentHooks._after.forEach(hook => hook(target, name, injects, ngModule));
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZWNvcmF0b3JzL2NvbXBvbmVudC50cyJdLCJuYW1lcyI6WyJhZnRlciIsImV4dGVuZERETyIsImJlZm9yZUN0cmxJbnZva2UiLCJhZnRlckN0cmxJbnZva2UiLCJDb21wb25lbnQiLCJWaWV3IiwiY29udHJvbGxlciJdLCJtYXBwaW5ncyI6Ik9Bd0NPLGFBQWEsTUFBTSx3QkFBd0I7T0FHM0MsRUFBQyxhQUFhLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBQyxNQUFNLFlBQVk7T0FHOUQsRUFBQyxTQUFTLEVBQUMsTUFBTSxhQUFhO09BRTlCLE1BQU0sTUFBTSxtQkFBbUI7T0FDL0IsMEJBQTBCLE1BQU0sOEJBQThCO09BQzlELEVBQUMsYUFBYSxFQUFDLE1BQU0sZ0JBQWdCO09BQ3JDLEVBQUMsU0FBUyxFQUFDLE1BQU0sOEJBQThCO09BQy9DLE1BQU0sTUFBTSxrQkFBa0I7T0FDOUIsRUFBQyx3QkFBd0IsRUFBQyxNQUFNLGlCQUFpQjtBQUV4RCxNQUFNLElBQUksR0FBRyxXQUFXLENBQUM7QUFFekIsYUFBYSxjQUFjLEdBQUc7SUFDN0IsTUFBTSxFQUFFLEVBQUU7SUFDVixVQUFVLEVBQUUsRUFBRTtJQUNkLGlCQUFpQixFQUFFLEVBQUU7SUFDckIsZ0JBQWdCLEVBQUUsRUFBRTtJQUVwQixLQUFLLENBQUMsRUFBK0U7UUFDcEZBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUFBO0lBQ3JCQSxDQUFDQTtJQUNELFNBQVMsQ0FBQyxFQUF5RjtRQUNsR0MsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQUE7SUFDekJBLENBQUNBO0lBQ0QsZ0JBQWdCLENBQUMsRUFBbUc7UUFDbkhDLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQUE7SUFDaENBLENBQUNBO0lBQ0QsZUFBZSxDQUFDLEVBQW1HO1FBQ2xIQyxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUFBO0lBQy9CQSxDQUFDQTtDQUNELENBQUM7QUFHRiwwQkFDRSxFQUNDLFFBQVEsRUFDUixZQUFZLEVBQ1osUUFBUSxFQUNSLFdBQVcsRUFDWCxTQUFTLEdBQUcsRUFBRSxFQUNkLE1BQU0sR0FBRyxFQUFFLEVBQ1gsT0FBTyxHQUFHLEVBQUUsRUFDWixLQUFLLEdBQUcsRUFBRSxFQUNWLFVBQVUsR0FBRyxFQUFFLEVBWWY7SUFFRkMsTUFBTUEsQ0FBQ0EsVUFBU0EsQ0FBTUE7UUFFckIsRUFBRSxDQUFBLENBQUUsQ0FBQyxRQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQyxJQUFJLHdDQUF3QyxDQUFDLENBQUM7UUFDbEcsQ0FBQztRQUdELElBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBQyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUdyRCxhQUFhLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBR25DLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUl6QyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsOEJBQThCLENBQUMsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDO1FBRzlFLGNBQWMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUc1QyxjQUFjLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFHbkMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBSTFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBR2hEO1lBQ0MsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDO1lBQ2xCLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQztZQUN4QixDQUFDLFlBQVksRUFBRSxVQUFVLENBQUM7WUFDMUIsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDO1NBQ3BCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDO1lBQzdCLEVBQUUsQ0FBQSxDQUFDLE9BQU8sS0FBSyxTQUFTLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUEsQ0FBQztnQkFDcEQsTUFBTSxJQUFJLFNBQVMsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDLElBQUksZ0JBQWdCLFFBQVEsbUJBQW1CLENBQUMsQ0FBQztZQUN6RyxDQUFDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7UUFFSCxhQUFhLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQztRQUVyQyxJQUFJLFNBQVMsR0FBRyxhQUFhLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN2RCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBSXZELEVBQUUsQ0FBQSxDQUFDLFlBQVksS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRzdCLGNBQWMsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFFekIsY0FBYyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUVQLGNBQWMsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvQyxDQUFDO1FBR0QsRUFBRSxDQUFBLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDWCxjQUFjLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFHRCxFQUFFLENBQUEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQztZQUNiLGNBQWMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUVELElBQUksQ0FBQztZQUNKLFFBQVE7WUFDUixRQUFRO1lBQ1IsV0FBVztZQUNYLEtBQUs7WUFDTCxVQUFVO1NBQ1YsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFBQTtBQUNGQSxDQUFDQTtBQUVELHFCQUNFLEVBQ0MsUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsS0FBSyxHQUFHLEVBQUUsRUFDVixVQUFVLEdBQUcsRUFBRSxFQVFmO0lBRUZDLE1BQU1BLENBQUNBLFVBQVNBLENBQU1BO1FBQ3JCLEVBQUUsQ0FBQSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDaEIsY0FBYyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ25ELENBQUM7UUFDRCxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNsQixjQUFjLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUNELElBQUksQ0FBQyxDQUFDO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxrR0FBa0csUUFBUSxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzVJLENBQUM7UUFFRCxTQUFTLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsOEJBQThCLENBQUMsQ0FBQyxJQUFJLGNBQWMsQ0FBQyxDQUFDO1FBQ2hGLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSw4QkFBOEIsQ0FBQyxDQUFDLElBQUksU0FBUyxDQUFDLENBQUM7SUFDdkUsQ0FBQyxDQUFBQTtBQUNGQSxDQUFDQTtBQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBVyxFQUFFLElBQVksRUFBRSxPQUFpQixFQUFFLFFBQW9CO0lBRTNGLElBQUksR0FBRyxHQUFRLEVBQUUsQ0FBQztJQUdsQixjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRzdELElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsR0FBRyxrQkFBa0IsR0FBRyxPQUFPLENBQUM7SUFDekUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7SUFJeEMsRUFBRSxDQUFBLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFDdkQsNkNBQTZDO1lBQzdDLHNDQUFzQyxDQUFDLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBSUQsVUFBVSxDQUFDLE9BQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNsRixvQkFBb0IsTUFBVyxFQUFFLFFBQWEsRUFBRSxNQUFXLEVBQUUsV0FBZ0IsRUFBRSxTQUFjO1FBQzVGQyxJQUFJQSxNQUFNQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxRQUFRQSxFQUFFQSxNQUFNQSxFQUFFQSxXQUFXQSxFQUFFQSxDQUFDQTtRQUV2REEsTUFBTUEsQ0FBQ0EsMEJBQTBCQSxDQUFDQSxJQUFJQSxFQUFFQSxPQUFPQSxFQUFFQSxNQUFNQSxFQUFFQSxHQUFHQSxFQUFFQSxTQUFTQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtJQUNsRkEsQ0FBQ0E7SUFDRCxHQUFHLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztJQUU1QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMxQyxHQUFHLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxlQUFlLENBQUMsQ0FBQTtJQUNwRSxDQUFDO0lBRUQsY0FBYyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUd0RixRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBRXBDLGNBQWMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUM5RSxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJsaWIvZGVjb3JhdG9ycy9jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAjIENvbXBvbmVudCBEZWNvcmF0b3Jcbi8vIFByb3ZpZGVzIGEgcm9idXN0IGNvbXBvbmVudCBkZWNvcmF0b3IgdGhhdCBhdHRlbXB0cyB0byBwb2x5ZmlsbCBtYW55IEFuZ3VsYXIgMlxuLy8gZmVhdHVyZXMgd2hpbGUgc3RpbGwgcHJvdmlkaW5nIGFuIGV4Y2VsbGVudCwgdGVzdGFibGUgQW5ndWxhciAxIGNvbXBvbmVudCBzdHJhdGVneVxuLy9cbi8vICMjIFVzYWdlXG4vLyBgYGBqc1xuLy8gaW1wb3J0IHtDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5qZWN0fSBmcm9tICduZy1mb3J3YXJkJztcbi8vIGltcG9ydCB7TWVzc2VuZ2VyfSBmcm9tICcuLi9tZXNzZW5nZXInO1xuLy9cbi8vIEBDb21wb25lbnQoe1xuLy8gXHRzZWxlY3RvcjogJ3NlbmQtbWVzc2FnZScsXG4vLyBcdG91dHB1dHM6IFsnc2VudCddLFxuLy8gXHRpbnB1dHM6IFsnbWVzc2FnZVN1YmplY3Q6IHN1YmplY3QnXSxcbi8vIFx0YmluZDogW01lc3Nlbmdlcl1cbi8vIFx0dGVtcGxhdGU6IGBcbi8vIFx0XHQ8dGV4dGFyZWEgbmctbW9kZWw9XCJjdHJsLmJvZHlcIj48L3RleHRhcmVhPlxuLy8gXHRcdDxidXR0b24gb24tY2xpY2s9XCJjdHJsLnNlbmQoKVwiPjwvdGV4dGFyZWE+XG4vLyBcdGBcbi8vIH0pXG4vLyBASW5qZWN0KE1lc3Nlbmdlcilcbi8vIGV4cG9ydCBjbGFzcyBTZW5kTWVzc2FnZXtcbi8vIFx0dGhpcy5zZW50ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuLy8gXHRjb25zdHJ1Y3RvcihNZXNzZW5nZXIpe1xuLy8gXHRcdHRoaXMuTWVzc2VuZ2VyID0gTWVzc2VuZ2VyO1xuLy8gXHRcdHRoaXMubWVzc2FnZSA9ICcnO1xuLy8gXHR9XG4vLyBcdGFzeW5jIHNlbmQoKXtcbi8vIFx0XHRsZXQgbWVzc2FnZSA9IGF3YWl0IHRoaXMuTWVzc2VuZ2VyLmNyZWF0ZSh0aGlzLnN1YmplY3QsIHRoaXMubWVzc2FnZSk7XG4vLyBcdFx0dGhpcy5zZW50Lm5leHQobWVzc2FnZSk7XG4vLyBcdH1cbi8vIH1cbi8vYGBgXG4vLyBJbiB5b3VyIEhUTUw6XG4vLyBgYGBodG1sXG4vLyA8c2VuZC1tZXNzYWdlIHN1YmplY3Q9XCJIZWxsbywgV29ybGQhXCIgKHNlbnQpPVwic2VudCgkZXZlbnQpXCI+PC9zZW5kLW1lc3NhZ2U+XG4vLyBgYGBcbi8vICMjIFNldHVwXG4vLyBgcGFyc2VTZWxlY3RvcmAgdGFrZXMgc29tZSBzaW1wbGUgQ1NTIHNlbGVjdG9yIGFuZCByZXR1cm5zIGEgY2FtZWxDYXNlZCB2ZXJzaW9uXG4vLyBvZiB0aGUgc2VsZWN0b3IgYXMgd2VsbCBhcyB0aGUgdHlwZSBvZiBzZWxlY3RvciBpdCB3YXMgKGVsZW1lbnQsIGF0dHJpYnV0ZSwgb3Jcbi8vIENTUyBjbGFzcykuXG5pbXBvcnQgcGFyc2VTZWxlY3RvciBmcm9tICcuLi91dGlsL3BhcnNlLXNlbGVjdG9yJztcbi8vIGBwcm92aWRlclN0b3JlYCBzZXRzIHVwIHByb3ZpZGVyIGluZm9ybWF0aW9uLCBgY29tcG9uZW50U3RvcmVgIHdyaXRlcyB0aGUgRERPLFxuLy8gYW5kIGBhcHBXcml0ZXJgIHNldHMgdXAgYXBwIHRyYXZlcnNhbC9ib290c3RyYXBwaW5nIGluZm9ybWF0aW9uLlxuaW1wb3J0IHtwcm92aWRlclN0b3JlLCBjb21wb25lbnRTdG9yZSwgYnVuZGxlU3RvcmV9IGZyb20gJy4uL3dyaXRlcnMnO1xuLy8gVGFrZXMgdGhlIGluZm9ybWF0aW9uIGZyb20gYGNvbmZpZy5wcm92aWRlcnNgIGFuZCB0dXJucyBpdCBpbnRvIHRoZSBhY3R1YWwgbWV0YWRhdGFcbi8vIG5lZWRlZCBkdXJpbmcgYXBwIHRyYXZlcnNhbFxuaW1wb3J0IHtQcm92aWRlcnN9IGZyb20gJy4vcHJvdmlkZXJzJztcbi8vIFByb3ZpZGVyIHBhcnNlciB3aWxsIG5lZWQgdG8gYmUgcmVnaXN0ZXJlZCB3aXRoIE1vZHVsZVxuaW1wb3J0IE1vZHVsZSBmcm9tICcuLi9jbGFzc2VzL21vZHVsZSc7XG5pbXBvcnQgZGlyZWN0aXZlQ29udHJvbGxlckZhY3RvcnkgZnJvbSAnLi4vdXRpbC9kaXJlY3RpdmUtY29udHJvbGxlcic7XG5pbXBvcnQge3dyaXRlTWFwTXVsdGl9IGZyb20gJy4vaW5wdXQtb3V0cHV0JztcbmltcG9ydCB7aW5wdXRzTWFwfSBmcm9tICcuLi9wcm9wZXJ0aWVzL2lucHV0cy1idWlsZGVyJztcbmltcG9ydCBldmVudHMgZnJvbSAnLi4vZXZlbnRzL2V2ZW50cyc7XG5pbXBvcnQge2NyZWF0ZUNvbmZpZ0Vycm9yTWVzc2FnZX0gZnJvbSAnLi4vdXRpbC9oZWxwZXJzJztcblxuY29uc3QgVFlQRSA9ICdjb21wb25lbnQnO1xuXG5leHBvcnQgY29uc3QgY29tcG9uZW50SG9va3MgPSB7XG5cdF9hZnRlcjogW10sXG5cdF9leHRlbmRERE86IFtdLFxuXHRfYmVmb3JlQ3RybEludm9rZTogW10sXG5cdF9hZnRlckN0cmxJbnZva2U6IFtdLFxuXG5cdGFmdGVyKGZuOiAodGFyZ2V0OiBhbnksIG5hbWU6IHN0cmluZywgaW5qZWN0czogc3RyaW5nW10sIG5nTW9kdWxlOiBuZy5JTW9kdWxlKSA9PiBhbnkpe1xuXHRcdHRoaXMuX2FmdGVyLnB1c2goZm4pXG5cdH0sXG5cdGV4dGVuZERETyhmbjogKGRkbzogYW55LCB0YXJnZXQ6IGFueSwgbmFtZTogc3RyaW5nLCBpbmplY3RzOiBzdHJpbmdbXSwgbmdNb2R1bGU6IG5nLklNb2R1bGUpID0+IGFueSl7XG5cdFx0dGhpcy5fZXh0ZW5kRERPLnB1c2goZm4pXG5cdH0sXG5cdGJlZm9yZUN0cmxJbnZva2UoZm46IChjYWxsZXI6IGFueSwgaW5qZWN0czogc3RyaW5nW10sIGNvbnRyb2xsZXI6IGFueSwgZGRvOiBhbnksICRpbmplY3RvcjogYW55LCBsb2NhbHM6IGFueSkgPT4gYW55KXtcblx0XHR0aGlzLl9iZWZvcmVDdHJsSW52b2tlLnB1c2goZm4pXG5cdH0sXG5cdGFmdGVyQ3RybEludm9rZShmbjogKGNhbGxlcjogYW55LCBpbmplY3RzOiBzdHJpbmdbXSwgY29udHJvbGxlcjogYW55LCBkZG86IGFueSwgJGluamVjdG9yOiBhbnksIGxvY2FsczogYW55KSA9PiBhbnkpe1xuXHRcdHRoaXMuX2FmdGVyQ3RybEludm9rZS5wdXNoKGZuKVxuXHR9XG59O1xuXG4vLyAjIyBEZWNvcmF0b3IgRGVmaW5pdGlvblxuZXhwb3J0IGZ1bmN0aW9uIENvbXBvbmVudChcblx0XHR7XG5cdFx0XHRzZWxlY3Rvcixcblx0XHRcdGNvbnRyb2xsZXJBcyxcblx0XHRcdHRlbXBsYXRlLFxuXHRcdFx0dGVtcGxhdGVVcmwsXG5cdFx0XHRwcm92aWRlcnMgPSBbXSxcblx0XHRcdGlucHV0cyA9IFtdLFxuXHRcdFx0b3V0cHV0cyA9IFtdLFxuXHRcdFx0cGlwZXMgPSBbXSxcblx0XHRcdGRpcmVjdGl2ZXMgPSBbXVxuXHRcdH0gOlxuXHRcdHtcblx0XHRcdHNlbGVjdG9yOiBzdHJpbmcsXG5cdFx0XHRjb250cm9sbGVyQXM/OiBzdHJpbmcsXG5cdFx0XHR0ZW1wbGF0ZT86IHN0cmluZyxcblx0XHRcdHRlbXBsYXRlVXJsPzogc3RyaW5nLFxuXHRcdFx0cHJvdmlkZXJzPzogYW55W10sXG5cdFx0XHRpbnB1dHM/OiBzdHJpbmdbXSxcblx0XHRcdG91dHB1dHM/OiBzdHJpbmdbXSxcblx0XHRcdHBpcGVzPzogYW55W10sXG5cdFx0XHRkaXJlY3RpdmVzPzogYW55W11cblx0XHR9XG5cdCl7XG5cdHJldHVybiBmdW5jdGlvbih0OiBhbnkpe1xuXHRcdC8vIFRoZSBvbmx5IHJlcXVpcmVkIGNvbmZpZyBpcyBhIHNlbGVjdG9yLiBJZiBvbmUgd2Fzbid0IHBhc3NlZCwgdGhyb3cgaW1tZWRpYXRlbHlcblx0XHRpZiggIXNlbGVjdG9yICkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBDb21wb25lbnQgRGVjb3JhdG9yIEVycm9yIGluIFwiJHt0Lm5hbWV9XCI6IENvbXBvbmVudCBzZWxlY3RvciBtdXN0IGJlIHByb3ZpZGVkYCk7XG5cdFx0fVxuXG5cdFx0Ly8gR3JhYiB0aGUgcHJvdmlkZXIgbmFtZSBhbmQgc2VsZWN0b3IgdHlwZSBieSBwYXJzaW5nIHRoZSBzZWxlY3RvclxuXHRcdGxldCB7bmFtZSwgdHlwZTogcmVzdHJpY3R9ID0gcGFyc2VTZWxlY3RvcihzZWxlY3Rvcik7XG5cblx0XHQvLyBTZXR1cCBwcm92aWRlciBpbmZvcm1hdGlvbiB1c2luZyB0aGUgcGFyc2VkIHNlbGVjdG9yXG5cdFx0cHJvdmlkZXJTdG9yZS5zZXQoJ25hbWUnLCBuYW1lLCB0KTtcblx0XHRwcm92aWRlclN0b3JlLnNldCgndHlwZScsIFRZUEUsIHQpO1xuXG5cdFx0Ly8gVGhlIGFwcFdyaXRlciBuZWVkcyB0aGUgcmF3IHNlbGVjdG9yLiBUaGlzIGxldHMgaXQgYm9vdHN0cmFwIHRoZSByb290IGNvbXBvbmVudFxuXHRcdGJ1bmRsZVN0b3JlLnNldCgnc2VsZWN0b3InLCBzZWxlY3RvciwgdCk7XG5cblx0XHQvLyBHcmFiIHRoZSBwcm92aWRlcnMgZnJvbSB0aGUgY29uZmlnIG9iamVjdCwgcGFyc2UgdGhlbSwgYW5kIHdyaXRlIHRoZSBtZXRhZGF0YVxuXHRcdC8vIHRvIHRoZSB0YXJnZXQuXG5cdFx0UHJvdmlkZXJzKC4uLnByb3ZpZGVycykodCwgYHdoaWxlIGFuYWx5emluZyBDb21wb25lbnQgJyR7dC5uYW1lfScgcHJvdmlkZXJzYCk7XG5cblx0XHQvLyBSZXN0cmljdCB0eXBlIG11c3QgYmUgJ2VsZW1lbnQnXG5cdFx0Y29tcG9uZW50U3RvcmUuc2V0KCdyZXN0cmljdCcsIHJlc3RyaWN0LCB0KTtcblxuXHRcdC8vIENvbXBvbmVudHMgc2hvdWxkIGFsd2F5cyBjcmVhdGUgYW4gaXNvbGF0ZSBzY29wZVxuXHRcdGNvbXBvbmVudFN0b3JlLnNldCgnc2NvcGUnLCB7fSwgdCk7XG5cblx0XHQvLyBTaW5jZSBjb21wb25lbnRzIG11c3QgaGF2ZSBhIHRlbXBsYXRlLCBzZXQgdHJhbnNjbHVkZSB0byB0cnVlXG5cdFx0Y29tcG9uZW50U3RvcmUuc2V0KCd0cmFuc2NsdWRlJywgdHJ1ZSwgdCk7XG5cblx0XHQvLyBJbnB1dHMgc2hvdWxkIGFsd2F5cyBiZSBib3VuZCB0byB0aGUgY29udHJvbGxlciBpbnN0YW5jZSwgbm90XG5cdFx0Ly8gdG8gdGhlIHNjb3BlXG5cdFx0Y29tcG9uZW50U3RvcmUuc2V0KCdiaW5kVG9Db250cm9sbGVyJywgdHJ1ZSwgdCk7XG5cblx0XHQvLyBNdXN0IHBlcmZvcm0gc29tZSBiYXNpYyBzaGFwZSBjaGVja2luZyBvbiB0aGUgY29uZmlnIG9iamVjdFxuXHRcdFtcblx0XHRcdFsnaW5wdXRzJywgaW5wdXRzXSxcblx0XHRcdFsncHJvdmlkZXJzJywgcHJvdmlkZXJzXSxcblx0XHRcdFsnZGlyZWN0aXZlcycsIGRpcmVjdGl2ZXNdLFxuXHRcdFx0WydvdXRwdXRzJywgb3V0cHV0c11cblx0XHRdLmZvckVhY2goKFtwcm9wTmFtZSwgcHJvcFZhbF0pID0+IHtcblx0XHRcdGlmKHByb3BWYWwgIT09IHVuZGVmaW5lZCAmJiAhQXJyYXkuaXNBcnJheShwcm9wVmFsKSl7XG5cdFx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYENvbXBvbmVudCBEZWNvcmF0b3IgRXJyb3IgaW4gXCIke3QubmFtZX1cIjogQ29tcG9uZW50ICR7cHJvcE5hbWV9IG11c3QgYmUgYW4gYXJyYXlgKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHdyaXRlTWFwTXVsdGkodCwgaW5wdXRzLCAnaW5wdXRNYXAnKTtcblxuXHRcdGxldCBvdXRwdXRNYXAgPSB3cml0ZU1hcE11bHRpKHQsIG91dHB1dHMsICdvdXRwdXRNYXAnKTtcblx0XHRPYmplY3Qua2V5cyhvdXRwdXRNYXApLmZvckVhY2goa2V5ID0+IGV2ZW50cy5hZGQoa2V5KSk7XG5cblxuXHRcdC8vIEFsbG93IGZvciByZW5hbWluZyB0aGUgY29udHJvbGxlckFzXG5cdFx0aWYoY29udHJvbGxlckFzID09PSAnJGF1dG8nKSB7XG5cdFx0XHQvLyBDb250cm9sbGVyQXMgaXMgdGhlIHBhcnNlZCBzZWxlY3Rvci4gRm9yIGV4YW1wbGUsIGBhcHBgIGJlY29tZXMgYGFwcGAgYW5kXG5cdFx0XHQvLyBgc2VuZC1tZXNzYWdlYCBiZWNvbWVzIGBzZW5kTWVzc2FnZWBcblx0XHRcdGNvbXBvbmVudFN0b3JlLnNldCgnY29udHJvbGxlckFzJywgbmFtZSwgdCk7XG5cdFx0fSBlbHNlIGlmIChjb250cm9sbGVyQXMpIHtcblx0XHRcdC8vIHNldCB0byB3aGF0IHdhcyBwcm92aWRlZFxuXHRcdFx0Y29tcG9uZW50U3RvcmUuc2V0KCdjb250cm9sbGVyQXMnLCBjb250cm9sbGVyQXMsIHQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBzZXQgdG8gZGVmYXVsdCBvZiAnY3RybCdcblx0XHRcdGNvbXBvbmVudFN0b3JlLnNldCgnY29udHJvbGxlckFzJywgJ2N0cmwnLCB0KTtcblx0XHR9XG5cblx0XHQvLyBTZXQgYSBsaW5rIGZ1bmN0aW9uXG5cdFx0aWYodC5saW5rKSB7XG5cdFx0XHRjb21wb25lbnRTdG9yZS5zZXQoJ2xpbmsnLCB0LmxpbmssIHQpO1xuXHRcdH1cblxuXHRcdC8vIFNldCBhIGNvbXBpbGUgZnVuY3Rpb25cblx0XHRpZih0LmNvbXBpbGUpe1xuXHRcdFx0Y29tcG9uZW50U3RvcmUuc2V0KCdjb21waWxlJywgdC5jb21waWxlLCB0KTtcblx0XHR9XG5cblx0XHRWaWV3KHtcblx0XHRcdHNlbGVjdG9yLFxuXHRcdFx0dGVtcGxhdGUsXG5cdFx0XHR0ZW1wbGF0ZVVybCxcblx0XHRcdHBpcGVzLFxuXHRcdFx0ZGlyZWN0aXZlc1xuXHRcdH0pKHQpO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBWaWV3KFxuXHRcdHtcblx0XHRcdHNlbGVjdG9yLFxuXHRcdFx0dGVtcGxhdGUsXG5cdFx0XHR0ZW1wbGF0ZVVybCxcblx0XHRcdHBpcGVzID0gW10sXG5cdFx0XHRkaXJlY3RpdmVzID0gW11cblx0XHR9IDpcblx0XHR7XG5cdFx0XHRzZWxlY3Rvcjogc3RyaW5nLFxuXHRcdFx0dGVtcGxhdGU/OiBzdHJpbmcsXG5cdFx0XHR0ZW1wbGF0ZVVybD86IHN0cmluZyxcblx0XHRcdHBpcGVzPzogYW55W10sXG5cdFx0XHRkaXJlY3RpdmVzPzogYW55W11cblx0XHR9XG4pe1xuXHRyZXR1cm4gZnVuY3Rpb24odDogYW55KXtcblx0XHRpZih0ZW1wbGF0ZVVybClcdHtcblx0XHRcdGNvbXBvbmVudFN0b3JlLnNldCgndGVtcGxhdGVVcmwnLCB0ZW1wbGF0ZVVybCwgdCk7XG5cdFx0fVxuXHRcdGVsc2UgaWYodGVtcGxhdGUpIHtcblx0XHRcdGNvbXBvbmVudFN0b3JlLnNldCgndGVtcGxhdGUnLCB0ZW1wbGF0ZSwgdCk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBAQ29tcG9uZW50IGNvbmZpZyBtdXN0IGluY2x1ZGUgZWl0aGVyIGEgdGVtcGxhdGUgb3IgYSB0ZW1wbGF0ZSB1cmwgZm9yIGNvbXBvbmVudCB3aXRoIHNlbGVjdG9yICR7c2VsZWN0b3J9IG9uICR7dC5uYW1lfWApO1xuXHRcdH1cblxuXHRcdFByb3ZpZGVycyguLi5kaXJlY3RpdmVzKSh0LCBgd2hpbGUgYW5hbHl6aW5nIENvbXBvbmVudCAnJHt0Lm5hbWV9JyBkaXJlY3RpdmVzYCk7XG5cdFx0UHJvdmlkZXJzKC4uLnBpcGVzKSh0LCBgd2hpbGUgYW5hbHl6aW5nIENvbXBvbmVudCAnJHt0Lm5hbWV9JyBwaXBlc2ApO1xuXHR9XG59XG5cbk1vZHVsZS5hZGRQcm92aWRlcihUWVBFLCAodGFyZ2V0OiBhbnksIG5hbWU6IHN0cmluZywgaW5qZWN0czogc3RyaW5nW10sIG5nTW9kdWxlOiBuZy5JTW9kdWxlKSA9PiB7XG5cdC8vIEZpcnN0IGNyZWF0ZSBhbiBlbXB0eSBvYmplY3QgdG8gY29udGFpbiB0aGUgZGlyZWN0aXZlIGRlZmluaXRpb24gb2JqZWN0XG5cdGxldCBkZG86IGFueSA9IHt9O1xuXG5cdC8vIExvb3AgdGhyb3VnaCB0aGUga2V5L3ZhbCBwYWlycyBvZiBtZXRhZGF0YSBhbmQgYXNzaWduIGl0IHRvIHRoZSBERE9cblx0Y29tcG9uZW50U3RvcmUuZm9yRWFjaCgodmFsLCBrZXkpID0+IGRkb1trZXldID0gdmFsLCB0YXJnZXQpO1xuXG5cdC8vIEdldCB0aGUgaW5wdXRzIGJpbmRpbmdzIGFoZWFkIG9mIHRpbWVcblx0bGV0IGJpbmRQcm9wID0gYW5ndWxhci52ZXJzaW9uLm1pbm9yID49IDQgPyAnYmluZFRvQ29udHJvbGxlcicgOiAnc2NvcGUnO1xuXHRkZG9bYmluZFByb3BdID0gaW5wdXRzTWFwKGRkby5pbnB1dE1hcCk7XG5cblx0Ly8gSWYgdGhlIHNlbGVjdG9yIHR5cGUgd2FzIG5vdCBhbiBlbGVtZW50LCB0aHJvdyBhbiBlcnJvci4gQ29tcG9uZW50cyBjYW4gb25seVxuXHQvLyBiZSBlbGVtZW50cyBpbiBBbmd1bGFyIDIsIHNvIHdlIHdhbnQgdG8gZW5mb3JjZSB0aGF0IHN0cmljdGx5IGhlcmUuXG5cdGlmKGRkby5yZXN0cmljdCAhPT0gJ0UnKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKGNyZWF0ZUNvbmZpZ0Vycm9yTWVzc2FnZSh0YXJnZXQsIG5nTW9kdWxlLFxuXHRcdFx0XHRgQENvbXBvbmVudCBzZWxlY3RvcnMgY2FuIG9ubHkgYmUgZWxlbWVudHMuIGAgK1xuXHRcdFx0XHRgUGVyaGFwcyB5b3UgbWVhbnQgdG8gdXNlIEBEaXJlY3RpdmU/YCkpO1xuXHR9XG5cblx0Ly8gQ29tcG9uZW50IGNvbnRyb2xsZXJzIG11c3QgYmUgY3JlYXRlZCBmcm9tIGEgZmFjdG9yeS4gQ2hlY2tvdXQgb3V0XG5cdC8vIHV0aWwvZGlyZWN0aXZlLWNvbnRyb2xsZXIuanMgZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgd2hhdCdzIGdvaW5nIG9uIGhlcmVcblx0Y29udHJvbGxlci4kaW5qZWN0ID0gWyckc2NvcGUnLCAnJGVsZW1lbnQnLCAnJGF0dHJzJywgJyR0cmFuc2NsdWRlJywgJyRpbmplY3RvciddO1xuXHRmdW5jdGlvbiBjb250cm9sbGVyKCRzY29wZTogYW55LCAkZWxlbWVudDogYW55LCAkYXR0cnM6IGFueSwgJHRyYW5zY2x1ZGU6IGFueSwgJGluamVjdG9yOiBhbnkpOiBhbnl7XG5cdFx0bGV0IGxvY2FscyA9IHsgJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCAkdHJhbnNjbHVkZSB9O1xuXG5cdFx0cmV0dXJuIGRpcmVjdGl2ZUNvbnRyb2xsZXJGYWN0b3J5KHRoaXMsIGluamVjdHMsIHRhcmdldCwgZGRvLCAkaW5qZWN0b3IsIGxvY2Fscyk7XG5cdH1cblx0ZGRvLmNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xuXG5cdGlmIChkZG8udGVtcGxhdGUgJiYgZGRvLnRlbXBsYXRlLnJlcGxhY2UpIHtcblx0XHRkZG8udGVtcGxhdGUgPSBkZG8udGVtcGxhdGUucmVwbGFjZSgvbmctY29udGVudC9nLCAnbmctdHJhbnNjbHVkZScpXG5cdH1cblxuXHRjb21wb25lbnRIb29rcy5fZXh0ZW5kRERPLmZvckVhY2goaG9vayA9PiBob29rKGRkbywgdGFyZ2V0LCBuYW1lLCBpbmplY3RzLCBuZ01vZHVsZSkpO1xuXG5cdC8vIEZpbmFsbHkgYWRkIHRoZSBjb21wb25lbnQgdG8gdGhlIHJhdyBtb2R1bGVcblx0bmdNb2R1bGUuZGlyZWN0aXZlKG5hbWUsICgpID0+IGRkbyk7XG5cblx0Y29tcG9uZW50SG9va3MuX2FmdGVyLmZvckVhY2goaG9vayA9PiBob29rKHRhcmdldCwgbmFtZSwgaW5qZWN0cywgbmdNb2R1bGUpKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
